<html>
<head>
	<meta charset="utf-8" />
    <link rel="stylesheet" type="text/css" href="./css/style.css">
	<title>可视化</title>
</head>
<body>
    <div class="container">
        <div class="con-left">
            <div style="color:#fff;">位置云</div>
            <div id="cloud" style="width: 100%;height:50%"></div>
            <div style="color:#fff;">云信息</div>
            <div id="cinfos">
              <div id="cloud_field">
                <div class="field">市</div>
                <div class="field">区</div>
                <div class="field">商圈</div>
                <div class="field">区域名</div>
                <div class="field">标签</div>
              </div>
              <div id="cloud_info">                
                <div class="info">上海市</div>
                <div class="info">虹口区</div>
                <div class="info">鲁迅公园</div>
                <div class="info">虹叶花苑</div>
                <div class="info">房地产</div>                
              </div>
            </div>
            <div style="clear: both;color:#fff;">路径分析</div>
            <div id="path_info" style="width:100%;height:50%">
              <ul style="width:100%;height:50%">
                <li>星期一 虹叶花苑<--->上海师大</li>
                <li>星期二 虹叶花苑<--->上海师大</li>
                <li>星期三 虹叶花苑<--->上海师大</li>
                <li>星期四 虹叶花苑<--->上海师大</li>
                <li>星期五 虹叶花苑-->上海师大-->恬润新苑</li>
                <li>星期六 恬润新苑<--->新理想花园</li>
                <li>星期天 恬润新苑<--->虹叶花苑</li>
              </ul>
            </div> 
        </div>
        
            <div id="containermap" style="height:100%;"></div>
        
    </div>
</body>
<script type="text/javascript" src="./js/jquery.min.js"></script>
<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=CC82b6daa32790ced0d3dff530fbac33"></script>
<script type="text/javascript" src="./js/echarts.js"></script>
<script src='./js/echarts-wordcloud.js'></script>
<script type="text/javascript" src="./js/bmap.min.js"></script>
<script type="text/javascript">
  var clouds = [];
  var chart = echarts.init(document.getElementById('cloud'));
  var geo=[];
  var bgeo=[];
  var poi = null;
  $.ajax({
      'poth':'get',
      'url':'http://localhost:8000/geo.json',
      'success':function(data){
          clouds = data;
          //把数据拼成echarts所能接受的数据格式，并去重
          for(var i = 0; i < clouds.length; i++){
            cloud = clouds[i]
              if(geo.toString().indexOf(cloud['community'])==-1){
                  if(cloud['community']!='\\\N'){
                   if(cloud["b_name"]=="\\\N") {
                    cloud["b_name"]=' ';
                    cloud["b_type"]=' ';
                   }
                   geo.push('{\"name\":\"'+cloud["community"]+'\",\"value\":'+cloud["weight"]+',\"province\":\"'+cloud["p_name"]+'\",\"city\":\"'+cloud["c_name"]+'\",\"area\":\"'+cloud["d_name"]+'\",\"business\":\"'+cloud["b_name"]+'\",\"business_type\":\"'+cloud["b_type"]+'\",\"tag\":\"'+cloud["tag"]+'\",\"lon\":'+cloud["lon"]+',\"lat\":'+cloud["lat"]+',\"polygon\":'+cloud['polygon']+'}');
                  }
              }
              if(bgeo.toString().indexOf(cloud['b_name'])==-1){
                  if(cloud['b_name']!=' ' && cloud['b_name']!='\\\N'){
                  bgeo.push('{\"name\":\"'+cloud["b_name"]+'\",\"value\":'+cloud["weight"]+',\"province\":\"'+cloud["p_name"]+'\",\"city\":\"'+cloud["c_name"]+'\",\"area\":\"'+cloud["d_name"]+'\",\"community\":\"'+cloud["community"]+'\",\"business_type\":\"'+cloud["b_type"]+'\",\"tag\":\"'+cloud["tag"]+'\",\"lon\":'+cloud["lon"]+',\"lat\":'+cloud["lat"]+',\"polygon\":'+cloud['polygon']+'}');
                  }
              }
          };
          geo=geo.concat(bgeo);

          for(var i = 0; i < geo.length; i++){
              geo[i]=$.parseJSON(geo[i])

          };
          var option = {
              tooltip: {},
              series: [ {
                  type: 'wordCloud',
                  gridSize: 1,
                  textPadding:0,
                  sizeRange: [12, 30],
                  rotationRange: [-90, 90],
                  shape: 'diamond',
                  width: '98%',
                  height: '100%',
                  drawOutOfBound: false,
                  textStyle: {
                      normal: {
                          color: function () {
                              return 'rgb(' + [
                                  Math.round(Math.random() * 160),
                                  Math.round(Math.random() * 160),
                                  Math.round(Math.random() * 160)
                              ].join(',') + ')';
                          }
                      },
                      emphasis: {
                          shadowBlur: 10,
                          shadowColor: '#333'
                      }
                  },
                  data: geo
              }]
          };
      chart.setOption(option);

      window.onresize = chart.resize;
      }
  });

//-----------------------------------------------------------------

  var dom = document.getElementById("containermap");
  var myChart = echarts.init(dom);
  var app = {};
  option = null;
  console.log(poi)
  app.title = 'echarts map test';

  //加载info，确定文件个数
  $.get('http://localhost:8000/tinfo.json', function(data) {
    file_num = parseInt(data['file_num'])
    if (data['file_num'] !=0 || data['file_num']!=undefined){
          var v = 1;
          $.get('http://localhost:8000/trajectory'+0+'.json', function(data){
          var lines = buildStep(data)
          buildEcharts(lines)
          });
          var timer = setInterval(function(){
            $.ajax({
              url:'http://localhost:8000/trajectory'+v+'.json',
              type:'Get',
              async:false,
              success:function(data){
                var option = myChart.getOption();
                var line = buildStep(data)
                $.each(line, function(index,value) {
                  option.series[0].data.push(value);
                  option.series[1].data.push(value);
                });
                myChart.setOption(option);
                console.log(v)
                v++;
              }
            });
            //达到文件数量上限，清除定时器
           if(v==(file_num)){
              clearInterval(timer);
            }
        }, 1000);
    }

  });

  var vdata = []//{name:'永安小区',value:200}
  var geoCoordMap = {}
  var convertData = function (data) {
    var res = [];
    for (var i = 0; i < data.length; i++) {
        var geoCoord = geoCoordMap[data[i].name];
        if (geoCoord) {
            res.push({
                name: data[i].name,
                value: geoCoord.concat(data[i].value),
              });
        }
    }
    return res;
  };
  var polygon =[];
  function renderItem(params, api) {
      var coords = polygon;
      var points = [];
      for (var i = 0; i < coords.length; i++) {
          points.push(api.coord(coords[i]));
      }
      //var color = api.visual('color');
      var color = '#FF8080';
      return {
          type: 'polygon',
          shape: {
              points: echarts.graphic.clipPointsByRect(points, {
                  x: params.coordSys.x,
                  y: params.coordSys.y,
                  width: params.coordSys.width,
                  height: params.coordSys.height
              })
          },
          style: api.style({
              fill: color,
              stroke: '#FFFFFF',
              lineWidth:2
          })
      };
  }

  /**
    对数组中的经纬度一样的进行去重
  **/
  function unique(array){
    
    var r = [];
    for(var i = 0, l = array.length; i < l; i++) {
      for(var j = i + 1; j < l; j++)
        if (array[i]['value'][0] == array[j]['value'][0] && array[i]['value'][1] == array[j]['value'][1] ){
          j = ++i;
          continue;
        };
      r.push(array[i]);
    }
    return r;
  }
  ser_data=[];
  
  //点击云标签时触发click事件
  chart.on('click', function (params) {
         if (params.componentType=='series'){
            poi = params.data;
            if(ser_data.length>0){
              ser_data=[];
            }
            
            if(poi['polygon']!=undefined){
              polygon = poi['polygon']
            }
            vdata.push({name:poi['name'],value:poi['value']})
          
            vdata = unique(vdata);
            
            geoCoordMap[poi['name']]=[poi['lon'],poi['lat']]
            if(!myChart){  
                return;  
            } 
            var option = myChart.getOption();  
            ser_data = ser_data.concat(convertData(vdata));
            ser_data = unique(ser_data);
            option.series[2].data = ser_data
            option.bmap[0].center = [poi['lon'],poi['lat']]
            option.bmap[0].zoom = 14
            //更新数据
            myChart.setOption(
              option
            )
            vdata=[];
            geoCoordMap={};

            //设置云信息
            $('#cloud_info .info')[0].innerText = poi['city'];
            $('#cloud_info .info')[1].innerText = poi['area'];
            if(poi['business']==undefined){
              $('#cloud_info .info')[2].innerText = poi['name'];
            }else{
              $('#cloud_info .info')[2].innerText = poi['business'];
            }
            
            if(poi['community']==undefined){
              $('#cloud_info .info')[3].innerText = poi['name'];
            }else{
              $('#cloud_info .info')[3].innerText = poi['community'];
            }
            $('#cloud_info .info')[4].innerText = poi['tag'];
         }
      });

/*
*根据步伐差，计算经纬度
*/
function buildStep(data){
var hStep = 300 / (data.length - 1);
      var Lines = [].concat.apply([], data.map(function (busLine, idx) {
          var prevPt;
          var points = [];
          for (var i = 0; i < busLine.length; i += 2) {
              var pt = [busLine[i], busLine[i + 1]];
              if (i > 0) {
                  pt = [
                      prevPt[0] + pt[0],
                      prevPt[1] + pt[1]
                  ];
              }
              prevPt = pt;

              points.push([pt[0] / 1e4, pt[1] / 1e4]);
          }
          return {
              coords: points,
              lineStyle: {
                  normal: {
                      color: echarts.color.modifyHSL('#DEA459', Math.round(hStep * idx))
                  }
              }
          };
      }));
      return Lines;
}

/*
*根据经纬度数据，构建Echarts Map
*/
function buildEcharts(busLines){
      option = {

          tooltip : {
              trigger: 'item'
          },
          bmap: {
              center: [121.38,31.13],
              zoom: 12,
              roam: true,
              mapStyle: {
                'styleJson': [
                  {
                    'featureType': 'water',
                    'elementType': 'all',
                    'stylers': {
                      'color': '#031628'
                    }
                  },
                  {
                    'featureType': 'land',
                    'elementType': 'geometry',
                    'stylers': {
                      'color': '#000102'
                    }
                  },
                  {
                    'featureType': 'highway',
                    'elementType': 'all',
                    'stylers': {
                      'visibility': 'off'
                    }
                  },
                  {
                    'featureType': 'arterial',
                    'elementType': 'geometry.fill',
                    'stylers': {
                      'color': '#000000'
                    }
                  },
                  {
                    'featureType': 'arterial',
                    'elementType': 'geometry.stroke',
                    'stylers': {
                      'color': '#0b3d51'
                    }
                  },
                  {
                    'featureType': 'local',
                    'elementType': 'geometry',
                    'stylers': {
                      'color': '#000000'
                    }
                  },
                  {
                    'featureType': 'railway',
                    'elementType': 'geometry.fill',
                    'stylers': {
                      'color': '#000000'
                    }
                  },
                  {
                    'featureType': 'railway',
                    'elementType': 'geometry.stroke',
                    'stylers': {
                      'color': '#08304b'
                    }
                  },
                  {
                    'featureType': 'subway',
                    'elementType': 'geometry',
                    'stylers': {
                      'lightness': -70
                    }
                  },
                  {
                    'featureType': 'building',
                    'elementType': 'geometry.fill',
                    'stylers': {
                      'color': '#000000'
                    }
                  },
                  {
                    'featureType': 'all',
                    'elementType': 'labels.text.fill',
                    'stylers': {
                      'color': '#857f7f'
                    }
                  },
                  {
                    'featureType': 'all',
                    'elementType': 'labels.text.stroke',
                    'stylers': {
                      'color': '#000000'
                    }
                  },
                  {
                    'featureType': 'building',
                    'elementType': 'geometry',
                    'stylers': {
                      'color': '#022338'
                    }
                  },
                  {
                    'featureType': 'green',
                    'elementType': 'geometry',
                    'stylers': {
                      'color': '#062032'
                    }
                  },
                  {
                    'featureType': 'boundary',
                    'elementType': 'all',
                    'stylers': {
                      'color': '#465b6c'
                    }
                  },
                  {
                    'featureType': 'manmade',
                    'elementType': 'all',
                    'stylers': {
                      'color': '#022338'
                    }
                  },
                  {
                    'featureType': 'label',
                    'elementType': 'all',
                    'stylers': {
                      'visibility': 'off'
                    }
                  }
                ]
              }
          },
          series: [{
              type: 'lines',
              coordinateSystem: 'bmap',
              polyline: true,
              //121.482498, lat: 31.263023
              data: busLines,
              silent: true,
              lineStyle: {
                  normal: {
                      // color: '#c23531',
                      // color: 'rgb(200, 35, 45)',
                      // opacity: 0.2,
                      width: 3
                  }
              },
              progressiveThreshold: 500,
              progressive: 200
          }, {
              type: 'lines',
              coordinateSystem: 'bmap',
              polyline: true,
              data: busLines,
              lineStyle: {
                  normal: {
                      width: 0
                  }
              },
              effect: {
                  constantSpeed: 20,
                  show: true,
                  trailLength: 0.1,
                  symbolSize: 5
              },
              zlevel: 1
          }
          ,{
              type: 'effectScatter',
              coordinateSystem: 'bmap',
              //121.482498,31.263023
              data: convertData(vdata),
              symbolSize: 10,
              //showEffectOn: 'emphasis',
              showEffectOn:'render',
              rippleEffect: {
                  brushType: 'stroke'
              },
              hoverAnimation: false,
              label: {
                  normal: {
                      formatter: '{b}',
                      position: 'right',
                      show: true
                  }
              },
              itemStyle: {
                  normal: {
                      color: '#f4e925',
                      shadowBlur: 10,
                      shadowColor: '#333'      
                  }
              },
              zlevel: 5
            },{
                type: 'custom',
                coordinateSystem: 'bmap',
                renderItem: renderItem,
                itemStyle: {
                    normal: {
                        opacity: 0.7
                    }
                },
                animation: false,
                silent: true,
                data: [0],
                z: -10
            }
          ]
      };
      myChart.setOption(option)
      if (!app.inNode) {
        // 添加百度地图插件
        var bmap = myChart.getModel().getComponent('bmap').getBMap();
        bmap.addControl(new BMap.MapTypeControl());
      }
}
</script>     
</html>